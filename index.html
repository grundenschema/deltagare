<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Deltagarschema ‚Äì Grunden DV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f7faff;
      color: #222;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 { color: #003366; margin-bottom: 10px; }
    .name-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
    button {
      background: #e9f3ff;
      border: 1px solid #bcd4ff;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 1.1rem;
      cursor: pointer;
    }
    button:hover { background: #d4e9ff; }
    .activity {
      background: #fff;
      border-left: 10px solid #9ecbff;
      border-radius: 12px;
      margin: 10px auto;
      padding: 10px;
      max-width: 600px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: left;
    }
    .activity h3 { margin: 0; font-size: 1.2rem; }
    .activity .time { font-weight: bold; }
    .day-heading {
      background: #eef5ff;
      border-radius: 8px;
      padding: 6px 10px;
      font-weight: bold;
      margin: 20px auto 10px;
      max-width: 600px;
      text-align: left;
    }
    #backBtn {
      display: none;
      margin: 20px auto;
      padding: 10px 20px;
      border: none;
      background: #003366;
      color: white;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    #backBtn:hover { background: #001f44; }

    /* Blockschema */
    #blockContainer { display:none; margin-top:20px; }
    .block-header, .block-grid {
      display:grid;
      grid-template-columns:80px repeat(5,1fr);
      max-width:95%;
      margin:0 auto;
    }
    .block-header div {
      background:#eef5ff;
      padding:6px;
      font-weight:700;
      border:1px solid #ddd;
    }
    .block-grid div {
      border:1px solid #eee;
      min-height:28px;
      font-size:.85rem;
      padding:3px;
    }
    .block {
      background:#fff;
      border-left:6px solid #ccc;
      border-radius:6px;
      padding:2px 4px;
      margin:1px;
    }
    .controls { margin:15px; }
  </style>
</head>
<body>
  <h1>Deltagarschema</h1>

  <div id="nameView">
    <p>V√§lj deltagare:</p>
    <div id="nameList" class="name-list">Laddar...</div>
  </div>

  <div id="scheduleView" style="display:none;">
    <h2 id="personTitle"></h2>
    <div class="controls">
      <button id="btnCards">Kortschema</button>
      <button id="btnBlocks">Blockschema</button>
    </div>
    <div id="schedule"></div>
  </div>

  <div id="blockContainer">
    <div id="blockHeader" class="block-header"></div>
    <div id="blockGrid" class="block-grid"></div>
  </div>

  <button id="backBtn">‚¨ÖÔ∏è Tillbaka till deltagarlista</button>

  <script>
    const url = "https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

    const aktivitetFarger = {
      "M√•ndagsm√∂te":{color:"#AED6F1",emoji:"üìÖ"}, "Gruppm√∂te":{color:"#7FB3D5",emoji:"üë•"},
      "Lunch":{color:"#F9E79F",emoji:"üç≤"}, "Frukost":{color:"#FAD7A0",emoji:"ü•ê"},
      "Atelj√©":{color:"#F5CBA7",emoji:"üé®"}, "Musik":{color:"#D2B4DE",emoji:"üé∂"},
      "Pod":{color:"#A9CCE3",emoji:"üéôÔ∏è"}, "Padel":{color:"#82E0AA",emoji:"üèì"},
      "Lite av varje":{color:"#FADBD8",emoji:"‚ú®"}, "Yoga":{color:"#D5F5E3",emoji:"üßò"},
      "Gym":{color:"#A3E4D7",emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"}, "Film":{color:"#E6B0AA",emoji:"üé¨"},
      "F√∂reningsgruppen":{color:"#D6DBDF",emoji:"ü§ù"}, "Trummor":{color:"#F1948A",emoji:"ü•Å"},
      "√Öterkoppling":{color:"#85C1E9",emoji:"üîÑ"}, "Medicin":{color:"#E59866",emoji:"üíä"},
      "Biljard":{color:"#A9DFBF",emoji:"üé±"}, "Spelgruppen":{color:"#F8C471",emoji:"üé≤"},
      "S√∂mnad":{color:"#F5EEF8",emoji:"üßµ"}, "Filmgruppen":{color:"#E6B0AA",emoji:"üé¨"},
      "Musikquizz":{color:"#D2B4DE",emoji:"üé∂"}, "Musikdokument√§r":{color:"#D2B4DE",emoji:"üé∂"}
    };

    let DATA = [], CURRENT = "";

    async function loadData() {
      const res = await fetch(url + "?t=" + Date.now());
      const json = await res.json();
      DATA = json.data || [];
      buildNameList();
    }

    function parseList(str) {
      return (str || "").split(/,|\/|;|\n| och /i).map(s => s.trim()).filter(Boolean);
    }

    function buildNameList() {
      const names = [...new Set(DATA.flatMap(r => parseList(r.Deltagare)))].filter(n => n.toLowerCase() !== "alla").sort();
      document.getElementById("nameList").innerHTML =
        names.map(n => `<button onclick="showSchedule('${n}')">${n}</button>`).join("");
    }

    function showSchedule(namn) {
      CURRENT = namn;
      document.getElementById("nameView").style.display = "none";
      document.getElementById("scheduleView").style.display = "block";
      document.getElementById("blockContainer").style.display = "none";
      document.getElementById("backBtn").style.display = "inline-block";
      document.getElementById("personTitle").textContent = namn;
      renderCards(namn);
    }

    function renderCards(namn) {
      const rows = DATA.filter(r => {
        const deltagare = (r.Deltagare || "").toLowerCase();
        return deltagare.includes(namn.toLowerCase()) || deltagare === "alla";
      }).sort((a,b)=>a.Datum.localeCompare(b.Datum)||(a.Start||"").localeCompare(b.Start||""));

      const byDay = {};
      rows.forEach(r => (byDay[r.Datum] = byDay[r.Datum] || []).push(r));

      let html = "";
      for (const d of Object.keys(byDay).sort()) {
        const label = new Date(d).toLocaleDateString("sv-SE",{weekday:"long",day:"numeric",month:"long"});
        html += `<div class="day-heading">${label}</div>`;
        byDay[d].forEach(r => {
          const akt = aktivitetFarger[r.Aktivitet] || {color:"#fff",emoji:""};
          html += `
            <div class="activity" style="border-left-color:${akt.color}">
              <div class="time">${r.Start||""}‚Äì${r.Slut||""}</div>
              <h3>${akt.emoji} ${r.Aktivitet||"Aktivitet"}</h3>
              <div>Coach: ${r.Coach||"-"}</div>
            </div>
          `;
        });
      }
      document.getElementById("schedule").innerHTML = html || "<p>Inget schema hittades.</p>";
    }

    // ===== BLOCKSCHEMA =====
    function renderBlocks(namn) {
      document.getElementById("schedule").innerHTML = "";
      document.getElementById("blockContainer").style.display = "block";

      const rows = DATA.filter(r => {
        const deltagare = (r.Deltagare||"").toLowerCase();
        return deltagare.includes(namn.toLowerCase()) || deltagare === "alla";
      });

      const days = [...new Set(rows.map(r=>r.Datum))].sort();
      const slots = makeSlots();
      const header = document.getElementById("blockHeader");
      const grid = document.getElementById("blockGrid");
      header.innerHTML = "<div>Tid</div>" + days.map(d => `<div>${new Date(d).toLocaleDateString("sv-SE",{weekday:"short"})}</div>`).join("");
      grid.innerHTML = "";

      slots.forEach(t=>{
        grid.innerHTML += `<div>${t}</div>` + days.map(()=>"<div></div>").join("");
      });

      const cells = [...grid.children];
      const dayMap={}; days.forEach((d,i)=>dayMap[d]=i+1);

      rows.forEach(r=>{
        const d=dayMap[r.Datum]; if(!d) return;
        const s=slots.indexOf(floorSlot(r.Start||"08:00"))+1;
        const e=slots.indexOf(floorSlot(r.Slut||"08:30"))+1;
        if(s<1||e<s)return;
        const akt=aktivitetFarger[r.Aktivitet]||{color:"#fff",emoji:""};
        const cellIndex=(s-1)*(1+days.length)+d;
        const cell=cells[cellIndex];
        if(!cell)return;
        const div=document.createElement("div");
        div.className="block";
        div.style.borderLeftColor=akt.color;
        div.innerHTML=`${akt.emoji} ${r.Aktivitet||"Aktivitet"}<br><small>${r.Start||""}-${r.Slut||""}</small>`;
        cell.appendChild(div);
      });
    }

    function makeSlots(){
      const out=[];let t=8*60;while(t<=16*60+30){
        out.push(String(Math.floor(t/60)).padStart(2,"0")+":"+String(t%60).padStart(2,"0"));t+=30;
      }return out;
    }
    function floorSlot(t){const [h,m]=t.split(":").map(Number);return `${String(h).padStart(2,"0")}:${m<30?"00":"30"}`;}

    // ===== KNAPPAR =====
    document.getElementById("btnCards").onclick = ()=>renderCards(CURRENT);
    document.getElementById("btnBlocks").onclick = ()=>renderBlocks(CURRENT);
    document.getElementById("backBtn").onclick = ()=>{
      document.getElementById("nameView").style.display="block";
      document.getElementById("scheduleView").style.display="none";
      document.getElementById("blockContainer").style.display="none";
      document.getElementById("backBtn").style.display="none";
    };

    loadData();
  </script>
</body>
</html>

