<!-- === DEL 1 === -->
<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Schemagenerator v6</title>

<!-- 
  Ã„ndringar i v6:
  âœ… Lokal datumhantering (fix fÃ¶r UTC-buggar)
  âœ… Print-delay 700 ms
  âœ… Chrome-cache med cache:"no-store"
  âœ… Block-tider utÃ¶kade 07:00â€“18:00
  âœ… SmÃ¥pass fÃ¥r tooltip
  âœ… Chippar klickfix
-->

<style>
/* === Baslayout === */
body {
  font-family: system-ui, sans-serif;
  margin: 0;
  padding: 0;
  background: #f5f5f5;
  color: #222;
}
header {
  background: #333;
  color: white;
  padding: 10px;
  text-align: center;
}
main {
  padding: 10px;
}
.hidden {
  display: none !important;
}
button, select, input {
  font-size: 1rem;
  margin: 3px;
}

/* === Vyhantering === */
.view {
  display: none;
}
.view.active {
  display: block;
}

/* === Kortlayout (block) === */
.block {
  position: absolute;
  left: 2px;
  right: 2px;
  border-radius: 8px;
  padding: 4px;
  background: #dfe9ff;
  overflow: hidden;
  font-size: 0.9em;
  cursor: pointer;
  transition: all 0.1s;
}
.block:hover {
  outline: 2px solid rgba(0,0,0,.15);
}
.block[title] { cursor: help; }

/* === Grid fÃ¶r veckovy === */
.week-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 6px;
}
.day-column {
  background: white;
  border-radius: 8px;
  padding: 5px;
  position: relative;
  height: 700px;
}
.day-header {
  font-weight: bold;
  margin-bottom: 4px;
  text-align: center;
}

/* === Filterchippar === */
.chip {
  display: inline-flex;
  align-items: center;
  background: #eee;
  border-radius: 16px;
  padding: 2px 8px;
  margin: 2px;
  cursor: pointer;
}
.chip.active {
  background: #007acc;
  color: white;
}
.chip input {
  display: none;
}

/* === PrintlÃ¤ge === */
@media print {
  body * { visibility: hidden; }
  .view.active, .view.active * { visibility: visible; }
  .view.active {
    position: absolute;
    left: 0; top: 0;
    width: 100%;
  }
}
</style>
</head>
<body>
<header>
  <h1>Schemagenerator v6</h1>
</header>
<main>
  <section id="controls">
    <button id="btnDelt">Deltagarschema</button>
    <button id="btnCoach">Coachschema</button>
    <button id="btnPÃ¥gÃ¥r">PÃ¥gÃ¥r nu</button>
    <button id="btnAss">Assistentvy</button>
    <button id="btnPrint">Skriv ut</button>
  </section>

  <!-- Vysektioner -->
  <section id="viewDelt" class="view"></section>
  <section id="viewCoach" class="view"></section>
  <section id="viewPÃ¥gÃ¥r" class="view"></section>
  <section id="viewAss" class="view"></section>
</main>
<script>
/* === DEL 2 kommer efter denna === */
<!-- === DEL 2 === -->
/* === HjÃ¤lpfunktioner fÃ¶r datum och tid === */

/* âœ… Fix 1: Lokal dagnyckel (ersÃ¤tter gamla UTC-buggen) */
function todayKey() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

/* âœ… Robust parser som funkar fÃ¶r bÃ¥de strÃ¤ngar och Date-objekt */
function dayKey(input) {
  if (input instanceof Date) {
    const d = input;
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }
  const s = String(input);
  const match = s.match(/(\d{4}-\d{2}-\d{2})/);
  return match ? match[1] : todayKey();
}

/* === TidshjÃ¤lp === */
function timeToMinutes(t) {
  if (!t) return 0;
  const [h, m] = t.split(":").map(Number);
  return h * 60 + (m || 0);
}

/* === HÃ¤mtar aktuell minut pÃ¥ dagen === */
function nowMinutes() {
  const d = new Date();
  return d.getHours() * 60 + d.getMinutes();
}

/* === Fix fÃ¶r Chrome-cache === */
/* âœ… cache:"no-store" + timestamp fÃ¶r att garantera fÃ¤rska data */
async function fetchJSON(url) {
  const res = await fetch(url + "?t=" + Date.now(), { cache: "no-store" });
  return await res.json();
}

/* === Samling med globala variabler === */
let DATA = [];
let DELT = [];
let COACH = [];

/* === Split namnlistor till rena tokens === */
function splitNames(str) {
  if (!str) return [];
  return str.split(/[,&\/]/).map(s => s.trim()).filter(Boolean);
}

/* === Unika tokens utan "alla" === */
function uniqueTokens(list) {
  const set = new Set();
  list.forEach(x => {
    splitNames(x).forEach(t => {
      if (t.toLowerCase() !== "alla") set.add(t);
    });
  });
  return Array.from(set).sort((a, b) => a.localeCompare(b, 'sv'));
}

/* === Fix fÃ¶r chip-klickbeteende (snabb dubbelklick) === */
function makeChip(label, group) {
  const chip = document.createElement("label");
  chip.className = "chip";
  chip.innerHTML = `<input type="checkbox" name="${group}" value="${label}">${label}`;
  chip.addEventListener("click", (ev) => {
    ev.preventDefault();
    const inp = chip.querySelector("input");
    inp.checked = !inp.checked;
    chip.classList.toggle("active");
  });
  return chip;
}

/* === HjÃ¤lpfunktion: renderar chip-listor === */
function renderChips(container, items, group) {
  container.innerHTML = "";
  items.forEach(x => container.appendChild(makeChip(x, group)));
}

/* === PÃ¥gÃ¥r nu-funktion med fixad sluttidsgrÃ¤ns === */
/* âœ… Sluttid exklusiv: < e istÃ¤llet fÃ¶r <= e */
function isNow(start, end) {
  const minsNow = nowMinutes();
  const s = timeToMinutes(start);
  const e = timeToMinutes(end);
  return minsNow >= s && minsNow < e;
}

/* === Funktion fÃ¶r aktuell veckas datum === */
/* âœ… AnvÃ¤nds fÃ¶r veckovy (mÃ¥nâ€“fre denna vecka) */
function currentWeekDates() {
  const today = new Date();
  const day = today.getDay();
  const diffToMonday = (day === 0 ? -6 : 1) - day;
  const monday = new Date(today);
  monday.setDate(today.getDate() + diffToMonday);
  return [...Array(5)].map((_, i) => {
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    return dayKey(d);
  });
}

/* === Generisk elementskapare === */
function el(tag, cls, text) {
  const e = document.createElement(tag);
  if (cls) e.className = cls;
  if (text) e.textContent = text;
  return e;
}

/* === DEL 3 kommer hÃ¤rnÃ¤st === */
<!-- === DEL 3 === -->
/* === RENDERING AV VECKOVYER OCH BLOCK === */

/* === Fix: Veckovy visar endast aktuell vecka === */
function renderSingleWeek(rows, container, title) {
  const weekKeys = new Set(currentWeekDates());
  const weekDays = ["MÃ¥ndag", "Tisdag", "Onsdag", "Torsdag", "Fredag"];
  const grid = el("div", "week-grid");

  weekDays.forEach((dayName, i) => {
    const col = el("div", "day-column");
    const header = el("div", "day-header", dayName);
    col.appendChild(header);
    const key = Array.from(weekKeys)[i];

    const dayRows = rows.filter(r => dayKey(r.Datum) === key);
    renderBlocksGeneric(dayRows, col);
    grid.appendChild(col);
  });

  container.innerHTML = "";
  container.appendChild(el("h2", "", title));
  container.appendChild(grid);
}

/* === Gemensam logik fÃ¶r alla block === */
/* âœ… Slotspann 07:00â€“18:00 (tidigare 08â€“16:30) */
function renderBlocksGeneric(rows, container) {
  const startMin = 7 * 60;
  const endMin = 18 * 60;
  const total = endMin - startMin;

  rows.forEach(r => {
    const block = el("div", "block");
    const s = timeToMinutes(r.Start);
    const e = timeToMinutes(r.Slut);
    const top = ((s - startMin) / total) * 100;
    const height = ((e - s) / total) * 100;

    /* === SmÃ¥pass tooltip === */
    const shortPass = (e - s) <= 30;
    const isCoach = !!r.Coach;
    block.textContent = shortPass
      ? `${r.Aktivitet || ""}`
      : `${r.Aktivitet || ""}\n${r.Start}-${r.Slut}`;
    block.title = `${r.Aktivitet || ""} ${r.Start || ""}â€“${r.Slut || ""} Â· ${isCoach ? "Deltagare: " + (r.Deltagare || "-") : "Coach: " + (r.Coach || "-")}`;

    block.style.top = `${top}%`;
    block.style.height = `${height}%`;

    container.appendChild(block);
  });
}

/* === RENDER DELTAGARSHEMA === */
function renderDeltagareView() {
  const view = document.getElementById("viewDelt");
  const inputs = [...document.querySelectorAll('input[name="deltagare"]:checked')].map(i => i.value);
  const weekKeys = new Set(currentWeekDates());
  const rows = DATA.filter(r => {
    const k = dayKey(r.Datum);
    if (!weekKeys.has(k)) return false;
    if (r.Deltagare && splitNames(r.Deltagare).some(x => inputs.includes(x))) return true;
    return false;
  });
  renderSingleWeek(rows, view, "Deltagarschema");
}

/* === RENDER COACHSCHEMA === */
function renderCoachView() {
  const view = document.getElementById("viewCoach");
  const inputs = [...document.querySelectorAll('input[name="coach"]:checked')].map(i => i.value);
  const weekKeys = new Set(currentWeekDates());
  const rows = DATA.filter(r => {
    const k = dayKey(r.Datum);
    if (!weekKeys.has(k)) return false;
    if (r.Coach && splitNames(r.Coach).some(x => inputs.includes(x))) return true;
    return false;
  });
  renderSingleWeek(rows, view, "Coachschema");
}

/* === RENDER PÃ…GÃ…R NU === */
function renderNowView() {
  const view = document.getElementById("viewPÃ¥gÃ¥r");
  const k = todayKey();
  const rows = DATA.filter(r => dayKey(r.Datum) === k && isNow(r.Start, r.Slut));

  view.innerHTML = "";
  view.appendChild(el("h2", "", "PÃ¥gÃ¥r just nu"));
  if (rows.length === 0) {
    view.appendChild(el("p", "", "Inga pÃ¥gÃ¥ende pass just nu."));
    return;
  }

  const list = el("ul");
  rows.forEach(r => {
    const li = el("li", "", `${r.Aktivitet || ""} (${r.Start}-${r.Slut}) â€” Deltagare: ${r.Deltagare || "-"} Â· Coach: ${r.Coach || "-"}`);
    list.appendChild(li);
  });
  view.appendChild(list);
}

/* === DEL 4 kommer hÃ¤rnÃ¤st (Assistentvyn och ersÃ¤ttare) === */
<!-- === DEL 4 === -->
/* === ASSISTENTVYN === */
/*
  âœ… Coachmatchningen i "ersÃ¤ttare" Ã¤r nu exakt:
     - AnvÃ¤nder splitNames() och jÃ¤mfÃ¶r namn skiftlÃ¤gesoberoende.
     - TidÃ¶verlapp kontrolleras korrekt.
*/

function renderAssistentView() {
  const view = document.getElementById("viewAss");
  view.innerHTML = "";
  view.appendChild(el("h2", "", "Assistentvy"));

  const kontroller = el("div", "ass-controls");
  const btnJmf = el("button", "", "JÃ¤mfÃ¶r deltagare");
  const btnErs = el("button", "", "ErsÃ¤ttare");
  kontroller.appendChild(btnJmf);
  kontroller.appendChild(btnErs);
  view.appendChild(kontroller);

  const output = el("div", "ass-output");
  view.appendChild(output);

  btnJmf.addEventListener("click", () => renderCompare(output));
  btnErs.addEventListener("click", () => renderReplacement(output));
}

/* === JÃ¤mfÃ¶r deltagare (enkelt tabellutskrift) === */
function renderCompare(container) {
  container.innerHTML = "";
  container.appendChild(el("h3", "", "JÃ¤mfÃ¶r deltagare"));

  const today = todayKey();
  const rows = DATA.filter(r => dayKey(r.Datum) === today);
  if (rows.length === 0) {
    container.appendChild(el("p", "", "Inga pass idag."));
    return;
  }

  const table = el("table");
  const header = el("tr");
  ["Deltagare", "Aktivitet", "Coach", "Start", "Slut"].forEach(h => {
    const th = el("th", "", h);
    header.appendChild(th);
  });
  table.appendChild(header);

  rows.forEach(r => {
    const tr = el("tr");
    [r.Deltagare, r.Aktivitet, r.Coach, r.Start, r.Slut].forEach(val => {
      tr.appendChild(el("td", "", val || ""));
    });
    table.appendChild(tr);
  });
  container.appendChild(table);
}

/* === ErsÃ¤ttare === */
function renderReplacement(container) {
  container.innerHTML = "";
  container.appendChild(el("h3", "", "ErsÃ¤ttare"));

  const k = todayKey();

  /* === Hitta pass markerade som "sjuk" === */
  const sickRows = DATA.filter(r =>
    dayKey(r.Datum) === k &&
    r.Status &&
    r.Status.toLowerCase().includes("sjuk")
  );

  if (sickRows.length === 0) {
    container.appendChild(el("p", "", "Inga sjukanmÃ¤lningar idag."));
    return;
  }

  sickRows.forEach(r => {
    const coachList = splitNames(r.Coach || "");
    const akt = r.Aktivitet || "";
    const block = el("div", "ersatt-block");
    block.appendChild(el("h4", "", `BehÃ¶ver ersÃ¤ttas: ${coachList.join(", ")} (${akt})`));

    /* === Hitta mÃ¶jliga ersÃ¤ttare === */
    const candidates = COACH.filter(c => {
      /* Hoppa Ã¶ver om coachen redan Ã¤r sjuk */
      if (coachList.map(x => x.toLowerCase()).includes(c.toLowerCase())) return false;

      /* Hitta ev. pass samma dag fÃ¶r denna coach */
      const overlaps = DATA.some(rr => {
        if (dayKey(rr.Datum) !== k) return false;
        const rrCoaches = splitNames(rr.Coach || "").map(x => x.toLowerCase());
        if (!rrCoaches.includes(c.toLowerCase())) return false;
        const s1 = timeToMinutes(r.Start), e1 = timeToMinutes(r.Slut);
        const s2 = timeToMinutes(rr.Start), e2 = timeToMinutes(rr.Slut);
        return (s1 < e2 && s2 < e1); // Ã¶verlappning
      });
      return !overlaps;
    });

    if (candidates.length === 0) {
      block.appendChild(el("p", "", "Ingen ledig coach hittad."));
    } else {
      const list = el("ul");
      candidates.forEach(c => list.appendChild(el("li", "", c)));
      block.appendChild(list);
    }

    container.appendChild(block);
  });
}

/* === DEL 5 kommer hÃ¤rnÃ¤st (DatainlÃ¤sning och vyhantering) === */
<!-- === DEL 5 === -->
/* === DATASYSTEM === */
/*
  âœ… Fetch anvÃ¤nder cache:"no-store"
  âœ… Automatisk init efter laddning
*/

async function loadData() {
  const url = "https://script.google.com/macros/s/YOUR_APPS_SCRIPT_URL/exec"; 
  try {
    DATA = await fetchJSON(url);

    // Generera deltagar- och coachlistor
    DELT = uniqueTokens(DATA.map(x => x.Deltagare));
    COACH = uniqueTokens(DATA.map(x => x.Coach));

    setupFilters();
  } catch (e) {
    alert("Fel vid dataladdning: " + e);
  }
}

/* === Filterpanel === */
function setupFilters() {
  const viewD = document.getElementById("viewDelt");
  const viewC = document.getElementById("viewCoach");

  // Skapa filterkontroller fÃ¶r deltagare
  const fD = el("div", "filters");
  fD.appendChild(el("h3", "", "VÃ¤lj deltagare:"));
  renderChips(fD, DELT, "deltagare");
  viewD.innerHTML = "";
  viewD.appendChild(fD);

  // Skapa filterkontroller fÃ¶r coacher
  const fC = el("div", "filters");
  fC.appendChild(el("h3", "", "VÃ¤lj coach:"));
  renderChips(fC, COACH, "coach");
  viewC.innerHTML = "";
  viewC.appendChild(fC);
}

/* === VYHANTERING === */
function showView(id) {
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  const v = document.getElementById(id);
  v.classList.add("active");
}

/* === Initknappar === */
document.getElementById("btnDelt").addEventListener("click", () => {
  showView("viewDelt");
  renderDeltagareView();
});
document.getElementById("btnCoach").addEventListener("click", () => {
  showView("viewCoach");
  renderCoachView();
});
document.getElementById("btnPÃ¥gÃ¥r").addEventListener("click", () => {
  showView("viewPÃ¥gÃ¥r");
  renderNowView();
});
document.getElementById("btnAss").addEventListener("click", () => {
  showView("viewAss");
  renderAssistentView();
});

/* === Fix: lÃ¤ngre delay vid utskrift === */
/* âœ… 700 ms istÃ¤llet fÃ¶r 300 ms fÃ¶r att undvika tomma utskrifter */
document.getElementById("btnPrint").addEventListener("click", () => {
  setTimeout(() => window.print(), 700);
});

/* === Starta appen === */
loadData();

/* === DEL 6 kommer hÃ¤rnÃ¤st (sluttaggar och avslutning) === */
<!-- === DEL 6 === -->
/*
  === SLUTANMÃ„RKNINGAR ===
  âœ… Datumhantering nu lokal (inga UTC-fel).
  âœ… â€œPÃ¥gÃ¥r nuâ€ visar rÃ¤tt pass och slutar exakt pÃ¥ sluttid.
  âœ… Chrome-cache neutraliserad (no-store + timestamp).
  âœ… Veckovy visar bara aktuell vecka (mÃ¥nâ€“fre).
  âœ… Slotspan 07:00â€“18:00.
  âœ… Tooltip fÃ¶r smÃ¥pass.
  âœ… Exakt coachmatch i ersÃ¤ttarvyn.
  âœ… LÃ¤ngre print-delay (700 ms).
  âœ… Fixat chip-klick (ingen dubbelklick-bugg).
*/
</script>
</body>
</html>


