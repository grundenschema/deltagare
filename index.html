<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Schema v6 ‚Äì Grunden DV</title>

<style>
:root{
  --bg:#f0f4f8;
  --card-bg:#fff;
  --border:#ddd;
  --shadow:0 3px 10px rgba(0,0,0,.06);
  --radius:14px;
  --blue:#c7dbfa; /* mildare bl√• */
  --muted:#555;
  --header-bg:#f5f7fa;
  --chip-bg:#f8fafc;
  --chip-border:#cfd8e3;
  --chip-active:#3b82f6;
  --chip-text:#1f2937;
}

/* Reset & bas */
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:var(--bg);
  color:#222;
  max-width:1400px;
  margin:0 auto;
  padding:14px;
}

/* Header */
header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:12px;
}
header img{height:48px;width:auto;cursor:pointer;}
#clock{font-weight:600;color:#333;font-size:1rem;}

/* Tillbaka-pil */
#backHome {
  font-size:1.6rem;
  cursor:pointer;
  color:#333;
  margin-right:8px;
}

/* Tabbar */
.tab-bar{
  display:grid; gap:10px; margin:8px 0 12px;
}
button.tab{
  background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;cursor:pointer;
  font-size:1.02rem; transition:.15s; box-shadow:var(--shadow);
}
button.tab:hover{background:#eef3fb}
button.tab.active{background:var(--blue);color:#000;border-color:var(--blue);}
@media (max-width:700px){
  .tab-bar{grid-template-columns:1fr 1fr;}
}
@media (min-width:701px){
  .tab-bar{grid-template-columns:repeat(4,1fr);}
}

/* Controls */
.controls{
  display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;margin-bottom:10px;
}
select, .btn{
  font-size:1rem;padding:10px 16px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;
}
.btn:hover{background:#eef3fb}
.btn.primary{background:#fff;border-color:#cfd8e3}
.btn.primary.active, .btn.primary:active{background:var(--blue);color:#000;border-color:var(--blue);}

/* Cards */
.cards{display:flex;flex-direction:column;gap:10px;max-width:1100px;margin:0 auto;}
.card{
  position:relative;background:var(--card-bg);border:1px solid var(--border);
  border-radius:var(--radius);padding:12px 14px;box-shadow:var(--shadow);
}
.card::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:6px;background:var(--band,#9ecbff);
  border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius);
}
.card h3{margin:0 0 6px;font-size:1.05rem}
.card .row{font-size:.95rem;color:#222}

.section-title{ text-align:center; margin:10px 0 8px; font-weight:800; font-size:1.15rem; }

/* Blocklayout */
#blockContainer{display:none;margin-top:8px;}
.block-header{
  display:grid;grid-template-columns:80px repeat(5,1fr);font-weight:800;font-size:.92rem;background:var(--header-bg);
  border-radius:10px 10px 0 0;text-transform:capitalize;
}
.block-header div{ text-align:center; padding:8px 0; }
.block-grid{ display:grid; grid-template-columns:80px repeat(5,1fr); background:transparent; }
.block-time{ font-size:.86rem; padding:4px 6px; text-align:right; color:#2b2b2b; }
.block-cell{ position:relative; min-height:28px; background:transparent; border:none; }
.block{
  position:absolute; left:2px; right:2px; top:2px;
  border-radius:10px; padding:6px 8px; line-height:1.25;
  font-size:.82rem; color:#111; box-shadow:var(--shadow);
  border:1px solid rgba(0,0,0,.15);
  word-break:break-word; overflow:hidden;
  -webkit-print-color-adjust:exact; print-color-adjust:exact;
}
.block .title{font-weight:700}

/* Paneler + chips */
.panel{
  display:none;background:#fff;border:1px solid #cfd8e3;border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.12);
  padding:16px;margin:14px auto; max-width:1200px;
}
.panel h2{margin:4px 0 10px;font-size:1.2rem}
.chip-group{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.chip-title{ font-weight:700; margin:10px 0 6px; }
.chip{ display:inline-flex; align-items:center; justify-content:center; gap:8px;
  background:#fff; border:1px solid var(--chip-border); color:var(--chip-text);
  border-radius:999px; padding:8px 14px; cursor:pointer; user-select:none;
  transition: background .15s, border-color .15s, color .15s; font-size:.95rem; font-weight:500;
}
.chip input{display:none;}
.chip.active{ background:var(--chip-active); border-color:var(--chip-active); color:#fff; }

/* Visningsytor */
.view{ display:none; }
.view.active{ display:block; }
#viewTitle{ text-align:center; margin:10px 0 8px; font-weight:800; }

/* P√•g√•r nu scroll */
.scroll-area{ max-height:350px; overflow-y:auto; padding-right:6px; }

/* Proffsig utskrift */
@media print {
  .print-header {
    display:flex !important;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid #ccc;
    padding:8px 12px 6px;
    margin-bottom:14px;
  }
  .print-header img { height:28px; }
  .print-header h2 {
    font-size:19pt;
    font-weight:800;
    margin:0;
  }
  .print-header .date {
    font-size:10pt;
    color:#333;
  }

  body {
    background:#fff;
    color:#000;
    font-size:10pt;
    margin:0;
    -webkit-print-color-adjust:exact;
    print-color-adjust:exact;
  }
  header, .tab-bar, .controls, .panel { display:none !important; }
  .view { display:none !important; visibility:hidden !important; }
  .print-visible { display:block !important; visibility:visible !important; position:relative !important; }

  @page { size:A4 landscape; margin:10mm; }
}
</style>
</head>

<body>
<header>
  <span id="backHome" title="Tillbaka till start">‚Ü©Ô∏è</span>
  <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="Grunden DV logotyp" id="homeLogo">
  <div id="clock"></div>
</header>

<!-- Flikar -->
<div class="tab-bar">
  <button id="tabParticipant" class="tab">üë§ Deltagarschema</button>
  <button id="tabCoach" class="tab">üßë‚Äçüè´ Coachschema</button>
  <button id="tabNow" class="tab active">üîî P√•g√•r nu</button>
  <button id="tabAssistant" class="tab">ü§ñ Schemaassistenten</button>
</div>

<!-- P√•g√•r nu-vy -->
<div id="nowView" class="view active">
  <div id="viewTitle">üîî P√•g√•r just nu</div>
  <div id="nowContainer" class="cards print-scope"></div>
  <div class="section-title">‚è≠Ô∏è Kommande aktiviteter idag</div>
  <div id="upcomingContainer" class="cards scroll-area print-scope"></div>
  <div style="text-align:center;margin-top:10px;">
    <button id="btnPrintNow" class="btn">üñ®Ô∏è Skriv ut</button>
  </div>
</div>
<!-- DELTAGARE-VY -->
<div id="participantView" class="view">
  <div id="viewTitle">üë§ Deltagarschema</div>
  <div class="controls">
    <select id="nameSelect"><option value="">-- V√§lj deltagare --</option></select>
    <button id="btnParticipantToday" class="btn primary">‚òÄÔ∏è Veckans schema</button>
    <button id="btnParticipantWeek" class="btn primary">üìÑ Utskriftsschema</button>
    <button id="btnPrintParticipant" class="btn">üñ®Ô∏è Skriv ut</button>
  </div>

  <div id="participantDay" class="cards print-scope"></div>

  <div id="participantWeek" class="print-scope" style="display:none;">
    <div class="print-header">
      <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="logga">
      <h2 id="participantPrintTitle"></h2>
      <div class="date" id="participantPrintDate"></div>
    </div>
    <div class="block-header" id="pBlockHeader"></div>
    <div class="block-grid" id="pBlockGrid"></div>
  </div>
</div>

<!-- COACH-VY -->
<div id="coachView" class="view">
  <div id="viewTitle">üßë‚Äçüè´ Coachschema</div>
  <div class="controls">
    <select id="coachSelect"><option value="">-- V√§lj coach --</option></select>
    <button id="btnCoachToday" class="btn primary">‚òÄÔ∏è Veckans schema</button>
    <button id="btnCoachWeek" class="btn primary">üìÑ Utskriftsschema</button>
    <button id="btnPrintCoach" class="btn">üñ®Ô∏è Skriv ut</button>
  </div>

  <div id="coachDay" class="cards print-scope"></div>

  <div id="coachWeek" class="print-scope" style="display:none;">
    <div class="print-header">
      <img src="https://cdn.prod.website-files.com/63e24702f042c50ffc91818b/646239316cf71bde35bcc2b4_grunden-DV-logo%20copy.png" alt="logga">
      <h2 id="coachPrintTitle"></h2>
      <div class="date" id="coachPrintDate"></div>
    </div>
    <div class="block-header" id="cBlockHeader"></div>
    <div class="block-grid" id="cBlockGrid"></div>
  </div>
</div>

<!-- SCHEMAASSISTENT-VY -->
<div id="assistantView" class="view">
  <div id="viewTitle">ü§ñ Schemaassistenten</div>

  <div id="comparePanel" class="panel">
    <h2>üîç J√§mf√∂r scheman</h2>
    <div class="chip-title">Coacher</div>
    <div id="coachListCompare" class="chip-group"></div>
    <div class="chip-title">Deltagare</div>
    <div id="participantListCompare" class="chip-group"></div>
    <div style="text-align:center; margin-top:12px;">
      <button id="btnShowCompare" class="btn primary">Visa valda scheman</button>
      <button id="btnPrintCompare" class="btn">üñ®Ô∏è Skriv ut</button>
    </div>
  </div>

  <div id="compareOutput" class="print-scope" style="display:none;"></div>

  <div id="sickPanel" class="panel">
    <h2>ü©∫ Hitta ers√§ttare</h2>
    <div class="controls">
      <select id="sickCoachSelect"><option value="">-- V√§lj sjuk coach --</option></select>
      <label style="display:inline-flex;gap:8px;align-items:center;">
        <input type="checkbox" id="chkFullWeek" checked> Visa hela veckan
      </label>
    </div>
    <div id="sickResult"></div>
  </div>

  <div class="controls" style="justify-content:center;margin-top:8px;">
    <button id="btnOpenCompare" class="btn primary">üîç √ñppna j√§mf√∂relse</button>
    <button id="btnOpenSick" class="btn primary">ü©∫ √ñppna ers√§ttare</button>
  </div>
</div>
<script>
/* =========================
   DATA & KONFIG
========================= */
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

/* Emoji & f√§rg per aktivitet */
const aktivitetFarger={
  "Atelj√©":{color:"#F5CBA7",emoji:"üé®"},
  "Musik":{color:"#D2B4DE",emoji:"üé∂"},
  "Lunch":{color:"#F9E79F",emoji:"üç≤"},
  "Gym":{color:"#A3E4D7",emoji:"üèãÔ∏è‚Äç‚ôÇÔ∏è"},
  "Morgonm√∂te":{color:"#AED6F1",emoji:"üå§Ô∏è"},
  "Fika":{color:"#FAD7A0",emoji:"‚òï"},
  "Promenad":{color:"#ABEBC6",emoji:"üö∂‚Äç‚ôÄÔ∏è"},
  "Film":{color:"#E6B0AA",emoji:"üé¨"},
  "Pod":{color:"#A9CCE3",emoji:"üéôÔ∏è"},
  "Yoga":{color:"#D5F5E3",emoji:"üßò"},
  "M√•ndagsm√∂te":{color:"#AED6F1",emoji:"üìÖ"},
  "Gruppm√∂te":{color:"#7FB3D5",emoji:"üë•"}
};
function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#edf2f7"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
function dayKey(str){return String(str).slice(0,10);}
function todayKey(){return new Date().toISOString().slice(0,10);}
function weekdayName(d){return ["s√∂ndag","m√•ndag","tisdag","onsdag","torsdag","fredag","l√∂rdag"][d];}

/* DATA */
let DATA=[];

/* Ladda data + init */
async function loadData(){
  try{
    const res=await fetch(url+"?t="+Date.now());
    const json=await res.json();
    DATA=json.data||[];
    fillLists(); fillCompareLists(); fillSickList();
    renderNow();
  }catch(e){ console.error("Kunde inte h√§mta data:", e); }
}
loadData();

/* Klocka */
function updateClock(){
  const el=document.getElementById("clock");
  if(!el) return;
  const now=new Date();
  el.textContent=now.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"});
}
setInterval(updateClock,1000); updateClock();

/* =========================
   LISTOR / UTVAL
========================= */
function uniqueTokens(field){
  return [...new Set(DATA.map(r=>(r[field]||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x && x.toLowerCase()!=="alla")
    .sort();
}
function sanitizeName(x){
  const bad=["alla","ingen coach","ingen","eget arbete",".","-","na","n/a","ok√§nt","unknown","(tom)",""];
  return x && !bad.includes(String(x).trim().toLowerCase());
}
function splitNames(str){
  return (str||"").split(/,|\/|;|\n/).map(s=>s.trim()).filter(sanitizeName);
}
function fillLists(){
  const n=document.getElementById("nameSelect");
  const c=document.getElementById("coachSelect");
  if(!n||!c) return;
  n.innerHTML='<option value="">-- V√§lj deltagare --</option>';
  c.innerHTML='<option value="">-- V√§lj coach --</option>';
  uniqueTokens("Deltagare").forEach(v=>n.innerHTML+=`<option>${v}</option>`);
  uniqueTokens("Coach").forEach(v=>c.innerHTML+=`<option>${v}</option>`);
}
function fillCompareLists(){
  const cWrap=document.getElementById("coachListCompare");
  const pWrap=document.getElementById("participantListCompare");
  if(!cWrap||!pWrap) return;
  cWrap.innerHTML=""; pWrap.innerHTML="";
  uniqueTokens("Coach").forEach(c=>{
    const id="c_"+btoa(encodeURIComponent(c)).replace(/=/g,"");
    cWrap.insertAdjacentHTML("beforeend",`
      <label class="chip" for="${id}"><input id="${id}" type="checkbox" class="chk-coach" value="${c}"><span>${c}</span></label>
    `);
  });
  uniqueTokens("Deltagare").forEach(n=>{
    const id="p_"+btoa(encodeURIComponent(n)).replace(/=/g,"");
    pWrap.insertAdjacentHTML("beforeend",`
      <label class="chip" for="${id}"><input id="${id}" type="checkbox" class="chk-delt" value="${n}"><span>${n}</span></label>
    `);
  });
  document.querySelectorAll(".chip").forEach(chip=>{
    chip.addEventListener("click",()=>{
      const inp=chip.querySelector("input");
      inp.checked=!inp.checked;
      chip.classList.toggle("active",inp.checked);
    });
  });
}
function fillSickList(){
  const s=document.getElementById("sickCoachSelect");
  if(!s) return;
  s.innerHTML='<option value="">-- V√§lj sjuk coach --</option>'+
    uniqueTokens("Coach").map(c=>`<option>${c}</option>`).join("");
}

/* =========================
   VY-HANTERING & TABS
========================= */
function showView(id){
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  if(id==="participantView") document.getElementById("tabParticipant").classList.add("active");
  if(id==="coachView") document.getElementById("tabCoach").classList.add("active");
  if(id==="nowView") document.getElementById("tabNow").classList.add("active");
  if(id==="assistantView") document.getElementById("tabAssistant").classList.add("active");
}
document.getElementById("tabParticipant").onclick=()=>{ showView("participantView"); };
document.getElementById("tabCoach").onclick=()=>{ showView("coachView"); };
document.getElementById("tabNow").onclick=()=>{ showView("nowView"); renderNow(); };
document.getElementById("tabAssistant").onclick=()=>{ showView("assistantView"); };
document.getElementById("homeLogo").onclick=()=>{ showView("nowView"); renderNow(); };
document.getElementById("backHome").onclick=()=>{ showView("nowView"); renderNow(); };

/* =========================
   P√ÖG√ÖR NU + KOMMANDE
========================= */
function renderNow(){
  const cont=document.getElementById("nowContainer");
  const upcoming=document.getElementById("upcomingContainer");
  const today=todayKey();
  const now=new Date();
  const minsNow=now.getHours()*60+now.getMinutes();
  const all=DATA.filter(r=>dayKey(r.Datum)===today)
                .sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  const ongo=all.filter(r=>{
    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    const [eh,em]=(r.Slut||"00:00").split(":").map(Number);
    const s=sh*60+sm,e=eh*60+em;
    return minsNow>=s && minsNow<=e;
  });
  const next=all.filter(r=>{
    const [sh,sm]=(r.Start||"00:00").split(":").map(Number);
    return sh*60+sm>minsNow;
  });

  cont.innerHTML=ongo.length
    ? ongo.map(r=>makeCard(r)).join("")
    : `<div class="card" style="--band:#ccc"><div class="row" style="text-align:center">Inga aktiviteter p√•g√•r just nu.</div></div>`;
  upcoming.innerHTML=next.length
    ? next.map(r=>makeCard(r)).join("")
    : `<div class="card" style="--band:#ccc"><div class="row" style="text-align:center">Inget mer planerat idag.</div></div>`;
}
function makeCard(r){
  const f=aktivitetFarger[r./* =========================
   VECKANS SCHEMA
========================= */
function renderBlocksGeneric(name,isCoach,headEl,gridEl){
  const today=new Date();
  const dayNames=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
  const currentDay=today.getDay();
  let ordered=dayNames.slice();

  // Aktuell dag f√∂rst, l√∂r/s√∂n => b√∂rja m√•ndag
  if(currentDay>=1 && currentDay<=5){
    const start=currentDay-1;
    ordered=dayNames.slice(start).concat(dayNames.slice(0,start));
  }

  const list=DATA.filter(r=>{
    const arr=splitNames(isCoach?r.Coach:r.Deltagare);
    return arr.includes(name);
  });

  // Sortera aktiviteter efter veckodag & tid
  const dayOrder={"m√•ndag":1,"tisdag":2,"onsdag":3,"torsdag":4,"fredag":5};
  list.sort((a,b)=>{
    const da=dayOrder[a.Dag.toLowerCase()]||0;
    const db=dayOrder[b.Dag.toLowerCase()]||0;
    if(da!==db) return da-db;
    return (a.Start||"").localeCompare(b.Start||"");
  });

  // Rubriker
  headEl.innerHTML='<div>Tid</div>'+ordered.map(d=>`<div>${d}</div>`).join("");
  gridEl.innerHTML="";

  const times=[...new Set(list.map(r=>r.Start))].sort();
  times.forEach(t=>{
    gridEl.insertAdjacentHTML("beforeend",`<div class="block-time">${t}</div>`+ordered.map(()=>`<div class="block-cell"></div>`).join(""));
  });

  // Rendera block
  list.forEach(r=>{
    const dIndex=ordered.indexOf(r.Dag.toLowerCase());
    if(dIndex===-1) return;
    const timeIndex=times.indexOf(r.Start);
    const pos=timeIndex*(ordered.length+1)+(dIndex+1);
    const cell=gridEl.children[pos];
    if(!cell) return;
    const f=aktivitetFarger[r.Aktivitet]||{color:"#ddd",emoji:"‚ùî"};
    const block=document.createElement("div");
    block.className="block";
    block.style.background=f.color;
    block.innerHTML=`<div class="title">${f.emoji} ${r.Aktivitet}</div>
                     <div>${isCoach?`üë• ${r.Deltagare}`:`üßë‚Äçüè´ ${r.Coach}`}</div>
                     <div>üïí ${r.Start}‚Äì${r.Slut}</div>`;
    cell.appendChild(block);
  });

  const titleEl=isCoach?document.getElementById("coachPrintTitle"):document.getElementById("participantPrintTitle");
  const dateEl=isCoach?document.getElementById("coachPrintDate"):document.getElementById("participantPrintDate");
  if(titleEl) titleEl.textContent=`Veckans schema ‚Äì ${name}`;
  if(dateEl) dateEl.textContent=new Date().toLocaleDateString("sv-SE");
}

/* =========================
   KORTVY (VECKANS SCHEMA I TEXT)
========================= */
function renderCardsGeneric(name,isCoach,container){
  const today=new Date();
  const dow=today.getDay();
  const dayNames=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
  const ordered=dow>=1&&dow<=5
    ? dayNames.slice(dow-1).concat(dayNames.slice(0,dow-1))
    : dayNames;
  const items=DATA.filter(r=>{
    const arr=splitNames(isCoach?r.Coach:r.Deltagare);
    return arr.includes(name);
  });
  items.sort((a,b)=>{
    const da=ordered.indexOf(a.Dag.toLowerCase());
    const db=ordered.indexOf(b.Dag.toLowerCase());
    if(da!==db) return da-db;
    return (a.Start||"").localeCompare(b.Start||"");
  });

  container.innerHTML=items.length
    ? items.map(r=>{
        const f=aktivitetFarger[r.Aktivitet]||{color:"#ddd",emoji:"‚ùî"};
        return `<div class="card" style="--band:${f.color}">
          <h3>${f.emoji} ${r.Aktivitet}</h3>
          <div class="row">üìÖ ${r.Dag}</div>
          <div class="row">üïí ${r.Start}‚Äì${r.Slut}</div>
          <div class="row">${isCoach?`üë• ${r.Deltagare}`:`üßë‚Äçüè´ ${r.Coach}`}</div>
        </div>`;
      }).join("")
    : `<div class="card"><div class="row" style="text-align:center">Inget schema hittades.</div></div>`;
}

/* =========================
   SCHEMAASSISTENT
========================= */
document.getElementById("btnOpenCompare").onclick=()=>{
  document.getElementById("comparePanel").style.display="block";
  document.getElementById("sickPanel").style.display="none";
};
document.getElementById("btnOpenSick").onclick=()=>{
  document.getElementById("sickPanel").style.display="block";
  document.getElementById("comparePanel").style.display="none";
};
document.getElementById("btnShowCompare").onclick=()=>{
  const selC=[...document.querySelectorAll(".chk-coach:checked")].map(i=>i.value);
  const selP=[...document.querySelectorAll(".chk-delt:checked")].map(i=>i.value);
  const names=[...selC,...selP];
  const out=document.getElementById("compareOutput");
  out.style.display="block";
  out.innerHTML=names.map(n=>`<h3>${n}</h3>`+
    DATA.filter(r=>splitNames(r.Coach).includes(n)||splitNames(r.Deltagare).includes(n))
    .map(r=>{
      const f=aktivitetFarger[r.Aktivitet]||{color:"#ddd",emoji:"‚ùî"};
      return `<div class="card" style="--band:${f.color}">
        <h3>${f.emoji} ${r.Aktivitet}</h3>
        <div class="row">${r.Dag} ${r.Start}‚Äì${r.Slut}</div>
        <div class="row">üßë‚Äçüè´ ${r.Coach}</div>
        <div class="row">üë• ${r.Deltagare}</div>
      </div>`;
    }).join("")).join("");
};

/* =========================
   UTSKRIFT ‚Äì endast aktivt schema
========================= */
function printScopeWithin(viewId){
  document.querySelectorAll('.print-scope').forEach(e=>e.classList.remove('print-visible'));
  const view=document.getElementById(viewId);
  if(!view){ window.print(); return; }

  const scopes=[...view.querySelectorAll('.print-scope')];
  const visible=scopes.find(n=>{
    const s=getComputedStyle(n);
    return s.display!=="none" && s.visibility!=="hidden";
  });
  if(visible) visible.classList.add('print-visible');
  setTimeout(()=>window.print(),200);
}

/* =========================
   KNAPPAR
========================= */
document.getElementById("btnParticipantToday").onclick=()=>{
  const name=document.getElementById("nameSelect").value;
  if(!name){ alert("V√§lj en deltagare."); return; }
  document.getElementById("participantWeek").style.display="none";
  document.getElementById("participantDay").style.display="block";
  renderCardsGeneric(name,false,document.getElementById("participantDay"));
};
document.getElementById("btnParticipantWeek").onclick=()=>{
  const name=document.getElementById("nameSelect").value;
  if(!name){ alert("V√§lj en deltagare."); return; }
  document.getElementById("participantDay").style.display="none";
  document.getElementById("participantWeek").style.display="block";
  renderBlocksGeneric(name,false,document.getElementById("pBlockHeader"),document.getElementById("pBlockGrid"));
};
document.getElementById("btnCoachToday").onclick=()=>{
  const name=document.getElementById("coachSelect").value;
  if(!name){ alert("V√§lj en coach."); return; }
  document.getElementById("coachWeek").style.display="none";
  document.getElementById("coachDay").style.display="block";
  renderCardsGeneric(name,true,document.getElementById("coachDay"));
};
document.getElementById("btnCoachWeek").onclick=()=>{
  const name=document.getElementById("coachSelect").value;
  if(!name){ alert("V√§lj en coach."); return; }
  document.getElementById("coachDay").style.display="none";
  document.getElementById("coachWeek").style.display="block";
  renderBlocksGeneric(name,true,document.getElementById("cBlockHeader"),document.getElementById("cBlockGrid"));
};
document.getElementById("btnPrintParticipant").onclick=()=>printScopeWithin("participantView");
document.getElementById("btnPrintCoach").onclick=()=>printScopeWithin("coachView");
document.getElementById("btnPrintNow").onclick=()=>printScopeWithin("nowView");
document.getElementById("btnPrintCompare").onclick=()=>printScopeWithin("assistantView");

/* =========================
   START: visa P√•g√•r nu
========================= */
document.addEventListener("DOMContentLoaded",()=>{
  showView("nowView");
  renderNow();
});
</script>
</body>
</html>
Aktivitet]||{color:"#ddd",emoji:"‚ùî"};
  return `
  <div class="card" style="--band:${f.color}">
    <h3>${f.emoji} ${r.Aktivitet}</h3>
    <div class="row">üïí ${r.Start}‚Äì${r.Slut}</div>
    <div class="row">üßë‚Äçüè´ ${r.Coach}</div>
    <div class="row">üë• ${r.Deltagare}</div>
  </div>`;
}
/* =========================
   VECKANS SCHEMA
========================= */
function renderBlocksGeneric(name,isCoach,headEl,gridEl){
  const today=new Date();
  const dayNames=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
  const currentDay=today.getDay();
  let ordered=dayNames.slice();

  // Aktuell dag f√∂rst, l√∂r/s√∂n => b√∂rja m√•ndag
  if(currentDay>=1 && currentDay<=5){
    const start=currentDay-1;
    ordered=dayNames.slice(start).concat(dayNames.slice(0,start));
  }

  const list=DATA.filter(r=>{
    const arr=splitNames(isCoach?r.Coach:r.Deltagare);
    return arr.includes(name);
  });

  // Sortera aktiviteter efter veckodag & tid
  const dayOrder={"m√•ndag":1,"tisdag":2,"onsdag":3,"torsdag":4,"fredag":5};
  list.sort((a,b)=>{
    const da=dayOrder[a.Dag.toLowerCase()]||0;
    const db=dayOrder[b.Dag.toLowerCase()]||0;
    if(da!==db) return da-db;
    return (a.Start||"").localeCompare(b.Start||"");
  });

  // Rubriker
  headEl.innerHTML='<div>Tid</div>'+ordered.map(d=>`<div>${d}</div>`).join("");
  gridEl.innerHTML="";

  const times=[...new Set(list.map(r=>r.Start))].sort();
  times.forEach(t=>{
    gridEl.insertAdjacentHTML("beforeend",`<div class="block-time">${t}</div>`+ordered.map(()=>`<div class="block-cell"></div>`).join(""));
  });

  // Rendera block
  list.forEach(r=>{
    const dIndex=ordered.indexOf(r.Dag.toLowerCase());
    if(dIndex===-1) return;
    const timeIndex=times.indexOf(r.Start);
    const pos=timeIndex*(ordered.length+1)+(dIndex+1);
    const cell=gridEl.children[pos];
    if(!cell) return;
    const f=aktivitetFarger[r.Aktivitet]||{color:"#ddd",emoji:"‚ùî"};
    const block=document.createElement("div");
    block.className="block";
    block.style.background=f.color;
    block.innerHTML=`<div class="title">${f.emoji} ${r.Aktivitet}</div>
                     <div>${isCoach?`üë• ${r.Deltagare}`:`üßë‚Äçüè´ ${r.Coach}`}</div>
                     <div>üïí ${r.Start}‚Äì${r.Slut}</div>`;
    cell.appendChild(block);
  });

  const titleEl=isCoach?document.getElementById("coachPrintTitle"):document.getElementById("participantPrintTitle");
  const dateEl=isCoach?document.getElementById("coachPrintDate"):document.getElementById("participantPrintDate");
  if(titleEl) titleEl.textContent=`Veckans schema ‚Äì ${name}`;
  if(dateEl) dateEl.textContent=new Date().toLocaleDateString("sv-SE");
}

/* =========================
   KORTVY (VECKANS SCHEMA I TEXT)
========================= */
function renderCardsGeneric(name,isCoach,container){
  const today=new Date();
  const dow=today.getDay();
  const dayNames=["m√•ndag","tisdag","onsdag","torsdag","fredag"];
  const ordered=dow>=1&&dow<=5
    ? dayNames.slice(dow-1).concat(dayNames.slice(0,dow-1))
    : dayNames;
  const items=DATA.filter(r=>{
    const arr=splitNames(isCoach?r.Coach:r.Deltagare);
    return arr.includes(name);
  });
  items.sort((a,b)=>{
    const da=ordered.indexOf(a.Dag.toLowerCase());
    const db=ordered.indexOf(b.Dag.toLowerCase());
    if(da!==db) return da-db;
    return (a.Start||"").localeCompare(b.Start||"");
  });

  container.innerHTML=items.length
    ? items.map(r=>{
        const f=aktivitetFarger[r.Aktivitet]||{color:"#ddd",emoji:"‚ùî"};
        return `<div class="card" style="--band:${f.color}">
          <h3>${f.emoji} ${r.Aktivitet}</h3>
          <div class="row">üìÖ ${r.Dag}</div>
          <div class="row">üïí ${r.Start}‚Äì${r.Slut}</div>
          <div class="row">${isCoach?`üë• ${r.Deltagare}`:`üßë‚Äçüè´ ${r.Coach}`}</div>
        </div>`;
      }).join("")
    : `<div class="card"><div class="row" style="text-align:center">Inget schema hittades.</div></div>`;
}

/* =========================
   SCHEMAASSISTENT
========================= */
document.getElementById("btnOpenCompare").onclick=()=>{
  document.getElementById("comparePanel").style.display="block";
  document.getElementById("sickPanel").style.display="none";
};
document.getElementById("btnOpenSick").onclick=()=>{
  document.getElementById("sickPanel").style.display="block";
  document.getElementById("comparePanel").style.display="none";
};
document.getElementById("btnShowCompare").onclick=()=>{
  const selC=[...document.querySelectorAll(".chk-coach:checked")].map(i=>i.value);
  const selP=[...document.querySelectorAll(".chk-delt:checked")].map(i=>i.value);
  const names=[...selC,...selP];
  const out=document.getElementById("compareOutput");
  out.style.display="block";
  out.innerHTML=names.map(n=>`<h3>${n}</h3>`+
    DATA.filter(r=>splitNames(r.Coach).includes(n)||splitNames(r.Deltagare).includes(n))
    .map(r=>{
      const f=aktivitetFarger[r.Aktivitet]||{color:"#ddd",emoji:"‚ùî"};
      return `<div class="card" style="--band:${f.color}">
        <h3>${f.emoji} ${r.Aktivitet}</h3>
        <div class="row">${r.Dag} ${r.Start}‚Äì${r.Slut}</div>
        <div class="row">üßë‚Äçüè´ ${r.Coach}</div>
        <div class="row">üë• ${r.Deltagare}</div>
      </div>`;
    }).join("")).join("");
};

/* =========================
   UTSKRIFT ‚Äì endast aktivt schema
========================= */
function printScopeWithin(viewId){
  document.querySelectorAll('.print-scope').forEach(e=>e.classList.remove('print-visible'));
  const view=document.getElementById(viewId);
  if(!view){ window.print(); return; }

  const scopes=[...view.querySelectorAll('.print-scope')];
  const visible=scopes.find(n=>{
    const s=getComputedStyle(n);
    return s.display!=="none" && s.visibility!=="hidden";
  });
  if(visible) visible.classList.add('print-visible');
  setTimeout(()=>window.print(),200);
}

/* =========================
   KNAPPAR
========================= */
document.getElementById("btnParticipantToday").onclick=()=>{
  const name=document.getElementById("nameSelect").value;
  if(!name){ alert("V√§lj en deltagare."); return; }
  document.getElementById("participantWeek").style.display="none";
  document.getElementById("participantDay").style.display="block";
  renderCardsGeneric(name,false,document.getElementById("participantDay"));
};
document.getElementById("btnParticipantWeek").onclick=()=>{
  const name=document.getElementById("nameSelect").value;
  if(!name){ alert("V√§lj en deltagare."); return; }
  document.getElementById("participantDay").style.display="none";
  document.getElementById("participantWeek").style.display="block";
  renderBlocksGeneric(name,false,document.getElementById("pBlockHeader"),document.getElementById("pBlockGrid"));
};
document.getElementById("btnCoachToday").onclick=()=>{
  const name=document.getElementById("coachSelect").value;
  if(!name){ alert("V√§lj en coach."); return; }
  document.getElementById("coachWeek").style.display="none";
  document.getElementById("coachDay").style.display="block";
  renderCardsGeneric(name,true,document.getElementById("coachDay"));
};
document.getElementById("btnCoachWeek").onclick=()=>{
  const name=document.getElementById("coachSelect").value;
  if(!name){ alert("V√§lj en coach."); return; }
  document.getElementById("coachDay").style.display="none";
  document.getElementById("coachWeek").style.display="block";
  renderBlocksGeneric(name,true,document.getElementById("cBlockHeader"),document.getElementById("cBlockGrid"));
};
document.getElementById("btnPrintParticipant").onclick=()=>printScopeWithin("participantView");
document.getElementById("btnPrintCoach").onclick=()=>printScopeWithin("coachView");
document.getElementById("btnPrintNow").onclick=()=>printScopeWithin("nowView");
document.getElementById("btnPrintCompare").onclick=()=>printScopeWithin("assistantView");

/* =========================
   START: visa P√•g√•r nu
========================= */
document.addEventListener("DOMContentLoaded",()=>{
  showView("nowView");
  renderNow();
});
</script>
</body>
</html>
