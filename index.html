<script>
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

const aktivitetFarger={
  "Måndagsmöte":{color:"#AED6F1",emoji:"📅"},"Gruppmöte":{color:"#7FB3D5",emoji:"👥"},
  "Lunch":{color:"#F9E79F",emoji:"🍲"},"Frukost":{color:"#FAD7A0",emoji:"🥐"},
  "Ateljé":{color:"#F5CBA7",emoji:"🎨"},"Musik":{color:"#D2B4DE",emoji:"🎶"},
  "Pod":{color:"#A9CCE3",emoji:"🎙️"},"Padel":{color:"#82E0AA",emoji:"🏓"},
  "Lite av varje":{color:"#FADBD8",emoji:"✨"},"Yoga":{color:"#D5F5E3",emoji:"🧘"},
  "Gym":{color:"#A3E4D7",emoji:"🏋️‍♂️"},"Film":{color:"#E6B0AA",emoji:"🎬"},
  "Föreningsgruppen":{color:"#D6DBDF",emoji:"🤝"},"Trummor":{color:"#F1948A",emoji:"🥁"},
  "Återkoppling":{color:"#85C1E9",emoji:"🔄"},"Medicin":{color:"#E59866",emoji:"💊"},
  "Biljard":{color:"#A9DFBF",emoji:"🎱"},"Spelgruppen":{color:"#F8C471",emoji:"🎲"},
  "Sömnad":{color:"#F5EEF8",emoji:"🧵"},"Filmgruppen":{color:"#E6B0AA",emoji:"🎬"},
  "Musikquizz":{color:"#D2B4DE",emoji:"🎶"},"Musikdokumentär":{color:"#D2B4DE",emoji:"🎶"},
  "Warhammer":{color:"#C39BD3",emoji:"🛡️"},"Uppstart Taket":{color:"#AED6F1",emoji:"🌤️"},
  "Gåträning":{color:"#ABEBC6",emoji:"🚶‍♂️"},"Promenad":{color:"#ABEBC6",emoji:"🚶‍♀️"},
  "Baka":{color:"#FAD7A0",emoji:"🧁"},"Utflykt":{color:"#A9CCE3",emoji:"🚌"},
};

function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#F4F6F7"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
function dayKey(str){return String(str).slice(0,10);}
function todayKey(){return new Date().toISOString().slice(0,10);}

let DATA=[];

async function loadData(){
  try{
    const res=await fetch(url+"?t="+Date.now());
    const json=await res.json();
    DATA=json.data||[];
    fillNameList();
    autoOpenFromLink();
    console.log("✅ Data uppdaterad från master "+new Date().toLocaleString("sv-SE"));
  }catch(e){console.error(e);}
}
loadData();

function fillNameList(){
  const s=document.getElementById("nameSelect");
  s.innerHTML='<option value="">-- Välj deltagare --</option>';
  [...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|-|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla")
    .sort().forEach(n=>{
      const o=document.createElement("option");
      o.value=n;
      o.textContent=n;
      s.appendChild(o);
    });
}

function applyMioRule(rows,name){
  return rows.filter(r=>{
    const isLunch=(r.Aktivitet||"").toLowerCase().includes("lunch");
    const isAll=(r.Deltagare||"").trim().toLowerCase()==="alla";
    if(isLunch&&isAll){
      const specific=rows.some(x=>
        x.Datum===r.Datum&&x.Start===r.Start&&x.Slut===r.Slut&&
        (x.Aktivitet||"").toLowerCase().includes("lunch")&&
        (x.Deltagare||"").toLowerCase().includes(name.toLowerCase()));
      if(specific) return false;
    }
    return true;
  });
}

function renderCards(name){
  const today=todayKey();
  const rows=applyMioRule(
    DATA.filter(r=>{
      const d=(r.Deltagare||"").toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      return (
        d.split(/,|\/|;|-|\n/)
          .map(x=>x.trim().toLowerCase())
          .some(x=>x===name.toLowerCase()) ||
        d==="alla"
      ) && dayKey(r.Datum)===today;
    }),name)
    .sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  const label=new Intl.DateTimeFormat("sv-SE",{weekday:"long",day:"numeric",month:"long"})
    .format(new Date(today));
  let html=`<h3>${label}</h3><div class="cards">`;
  if(!rows.length){html+="<p>Inga aktiviteter idag.</p>";}
  rows.forEach(r=>{
    const b=colorFor(r), e=emojiFor(r);
    html+=`<div class="card" style="--band:${b}">
      <h3>${e} ${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">🕒 ${r.Start||""}–${r.Slut||""}</div>
      <div class="row">🧑‍🏫 Coach: ${r.Coach||"-"}</div>
    </div>`;
  });
  html+="</div>";
  document.getElementById("schemaContainer").innerHTML=html;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("viewTitle").textContent=`Dagens schema – ${name}`;
}

function makeSlots(){
  const a=[];
  for(let h=8;h<=16;h++){
    a.push(`${String(h).padStart(2,"0")}:00`,`${String(h).padStart(2,"0")}:30`);
  }
  a.push("16:30");
  return a;
}

/* ================================
   renderBlocks – version 4 fix
   ================================ */
function renderBlocks(name){
  const slots=makeSlots(), days=[...new Set(DATA.map(r=>dayKey(r.Datum)))].sort();

  // 🔧 Uppdaterad filtrering – samma logik som kortvyn
  const rows = applyMioRule(DATA.filter(r => {
    const d = (r.Deltagare || "")
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase();
    const tokens = d.split(/,|\/|;|-|\n/).map(x => x.trim()).filter(Boolean);
    return tokens.includes(name.toLowerCase()) || d.trim() === "alla";
  }), name);

  const head=document.getElementById("blockHeader"),
        grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div>"+days.map(d=>
    `<div>${new Intl.DateTimeFormat("sv-SE",{weekday:"short"}).format(new Date(d))}</div>`
  ).join("");
  grid.innerHTML="";
  grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{
    grid.innerHTML+=`<div class="block-time">${t}</div>`+
      days.map(()=>`<div class="block-cell"></div>`).join("");
  });
  const cells=[...grid.children], dayMap={};
  days.forEach((d,i)=>dayMap[d]=i+1);
  const toMin=t=>{const [h,m]=t.split(":").map(Number);return h*60+m;};

  rows.forEach(r=>{
    const dk=dayKey(r.Datum),col=dayMap[dk];
    if(!col)return;
    const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx)return;
    const firstCellIndex=(sIdx)*(1+days.length)+col,firstCell=cells[firstCellIndex];
    const block=document.createElement("div");
    block.className="block";
    block.style.background=colorFor(r);
    const duration=toMin(r.Slut)-toMin(r.Start);
    if(duration<=30){
      block.innerHTML=`${emojiFor(r)} ${r.Aktivitet||""} – ${r.Coach||"-"}`;
    }else{
      block.innerHTML=`${emojiFor(r)} ${r.Aktivitet||""}<br>${r.Start||""}–${r.Slut||""}<br>Coach: ${r.Coach||"-"}`;
    }
    requestAnimationFrame(()=>{
      const cellH=firstCell.clientHeight||28;
      block.style.height=(eIdx-sIdx)*cellH+"px";
    });
    firstCell.appendChild(block);
  });

  const today=new Date();
  const dateLabel=today.toLocaleDateString("sv-SE");
  document.getElementById("viewTitle").textContent=`Veckoschema – ${name} – utskrivet ${dateLabel}`;
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="block";
}

function getParams() {
  const params = new URLSearchParams(window.location.search);
  return { namn: params.get("namn") || "", vy: params.get("vy") || "" };
}

function autoOpenFromLink() {
  const { namn, vy } = getParams();
  if (!namn) return;
  const select = document.getElementById("nameSelect");
  const trySelect = () => {
    const option = [...select.options]
      .find(o => o.value.toLowerCase() === namn.toLowerCase());
    if (option) {
      select.value = option.value;
      if (vy === "block") renderBlocks(option.value);
      else renderCards(option.value);
    }
  };
  if (DATA.length) trySelect();
  else setTimeout(trySelect, 800);
}

/* 🔍 Jämför master mot nuvarande DATA */
async function compareWithMaster(){
  try{
    const res=await fetch(url+"?t="+Date.now());
    const json=await res.json();
    const master=json.data||[];
    const missing=master.filter(m=>{
      return !DATA.some(d=>
        d.Datum===m.Datum &&
        (d.Start||"")===(m.Start||"") &&
        (d.Slut||"")===(m.Slut||"") &&
        (d.Aktivitet||"")===(m.Aktivitet||"")
      );
    });
    alert(missing.length
      ? `⚠️ Skillnader hittade: ${missing.length} rader finns i master men inte i webben.\nExempel:\n${missing.slice(0,5).map(x=>`${x.Datum} ${x.Start}-${x.Slut} ${x.Aktivitet}`).join("\n")}`
      : "✅ Webbsidan matchar master (inga skillnader funna).");
  }catch(e){
    alert("Kunde inte jämföra med master.");console.error(e);
  }
}

/* Knappar */
document.getElementById("btnCards").onclick=()=>{
  const n=document.getElementById("nameSelect").value;
  if(n)renderCards(n);
};
document.getElementById("btnBlocks").onclick=()=>{
  const n=document.getElementById("nameSelect").value;
  if(n)renderBlocks(n);
};
document.getElementById("btnPrint").onclick=()=>{window.print();};
document.getElementById("btnReload").onclick=()=>{loadData();};
document.getElementById("btnCompare").onclick=()=>{compareWithMaster();};
</script>


