<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deltagarschema</title>

<style>
:root{
  --card-bg:#fff;--border:#ddd;--shadow:0 3px 10px rgba(0,0,0,.05);
  --radius:16px;--print-scale:1;
}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  margin:0 auto;max-width:1400px;padding:20px;background:#fafafa;
}
header{text-align:center;margin-bottom:10px;}
h1{margin:0;font-size:1.4rem;}
select,button{
  font-size:1rem;padding:10px 14px;border-radius:10px;border:1px solid #ccc;
  background:#f8f8f8;cursor:pointer;
}
select{width:220px;}
button:hover{background:#eee;}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:15px;}

.cards{display:flex;flex-direction:column;gap:12px;}
.card{
  border:1px solid var(--border);border-radius:var(--radius);
  box-shadow:var(--shadow);padding:12px 16px;background:var(--card-bg);
  position:relative;
}
.card::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:6px;background:var(--band,#ccc);
  border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius);
}
.card h3{margin:0;font-size:1.1rem;}
.row{font-size:.95rem;margin-top:4px;}

#blockContainer{display:none;margin-top:10px;}
.block-header{display:grid;grid-template-columns:80px repeat(5,1fr);font-weight:bold;}
.block-grid{display:grid;grid-template-columns:80px repeat(5,1fr);}
.block-time{background:#fafafa;font-size:.85rem;padding:3px 6px;}
.block-cell{position:relative;min-height:28px;border:none;}
.block{
  position:absolute;left:2px;right:2px;top:2px;
  border-radius:8px;padding:4px 6px;line-height:1.2;
  border:1pt solid #666;font-size:.8rem;
  word-break:break-word;overflow:hidden;
  -webkit-print-color-adjust:exact;print-color-adjust:exact;
}

@media print{
  body{background:#fff;color:#000;font-size:9pt;margin:0;}
  header,.toolbar{display:none !important;}
  #blockContainer{display:block !important;transform:scale(var(--print-scale,1));transform-origin:top left;}
  @page{size:A4 landscape;margin:6mm;}
}
</style>
</head>
<body>
<header><h1>Deltagarschema</h1></header>

<div class="toolbar">
  <select id="nameSelect"><option value="">-- Välj deltagare --</option></select>
  <button id="btnCards">Dagens schema</button>
  <button id="btnBlocks">Blockschema</button>
  <button id="btnPrint">🖨️ Skriv ut</button>
  <!-- 🔄 Ny knapp för manuell uppdatering -->
  <button id="btnReload">🔄 Uppdatera från master</button>
</div>

<h2 id="viewTitle"></h2>
<div id="schemaContainer"></div>
<div id="blockContainer">
  <div class="block-header" id="blockHeader"></div>
  <div class="block-grid" id="blockGrid"></div>
</div>

<script>
const url="https://script.google.com/macros/s/AKfycbyrif6NVB3DPkmSam6kOX_M3xcXcrkBGFKVznDV2PRrUxIrN0q9c16VCgNQ7fFtrwBS/exec";

// 🎨 färger och emojis
const aktivitetFarger={
  "Måndagsmöte":{color:"#AED6F1",emoji:"📅"},"Gruppmöte":{color:"#7FB3D5",emoji:"👥"},
  "Lunch":{color:"#F9E79F",emoji:"🍲"},"Frukost":{color:"#FAD7A0",emoji:"🥐"},
  "Ateljé":{color:"#F5CBA7",emoji:"🎨"},"Musik":{color:"#D2B4DE",emoji:"🎶"},
  "Pod":{color:"#A9CCE3",emoji:"🎙️"},"Padel":{color:"#82E0AA",emoji:"🏓"},
  "Lite av varje":{color:"#FADBD8",emoji:"✨"},"Yoga":{color:"#D5F5E3",emoji:"🧘"},
  "Gym":{color:"#A3E4D7",emoji:"🏋️‍♂️"},"Film":{color:"#E6B0AA",emoji:"🎬"},
  "Föreningsgruppen":{color:"#D6DBDF",emoji:"🤝"},"Trummor":{color:"#F1948A",emoji:"🥁"},
  "Återkoppling":{color:"#85C1E9",emoji:"🔄"},"Medicin":{color:"#E59866",emoji:"💊"},
  "Biljard":{color:"#A9DFBF",emoji:"🎱"},"Spelgruppen":{color:"#F8C471",emoji:"🎲"},
  "Sömnad":{color:"#F5EEF8",emoji:"🧵"},"Filmgruppen":{color:"#E6B0AA",emoji:"🎬"},
  "Musikquizz":{color:"#D2B4DE",emoji:"🎶"},"Musikdokumentär":{color:"#D2B4DE",emoji:"🎶"},
  "Warhammer":{color:"#C39BD3",emoji:"🛡️"},"Uppstart Taket":{color:"#AED6F1",emoji:"🌤️"},
  "Gåträning":{color:"#ABEBC6",emoji:"🚶‍♂️"},"Promenad":{color:"#ABEBC6",emoji:"🚶‍♀️"},
  "Baka":{color:"#FAD7A0",emoji:"🧁"},"Utflykt":{color:"#A9CCE3",emoji:"🚌"},
};
function colorFor(r){return(aktivitetFarger[r.Aktivitet]||{color:"#F4F6F7"}).color;}
function emojiFor(r){return(aktivitetFarger[r.Aktivitet]||{emoji:""}).emoji;}
function dayKey(str){return String(str).slice(0,10);}
function todayKey(){return new Date().toISOString().slice(0,10);}

// 🧠 data
let DATA=[];
async function loadData(){
  try{
    const res=await fetch(url+"?t="+Date.now());
    const json=await res.json();
    DATA=json.data||[];
    fillNameList();
    autoOpenFromLink();
  }catch(e){console.error(e);}
}
loadData();

// fyll namnlista
function fillNameList(){
  const s=document.getElementById("nameSelect");
  s.innerHTML='<option value="">-- Välj deltagare --</option>';
  [...new Set(DATA.map(r=>(r.Deltagare||"").split(/,|\/|;|\n/).map(x=>x.trim())).flat())]
    .filter(x=>x&&x.toLowerCase()!=="alla")
    .sort().forEach(n=>{
      const o=document.createElement("option");o.value=n;o.textContent=n;s.appendChild(o);
    });
}

// 🍽️ Mio-regel
function applyMioRule(rows,name){
  return rows.filter(r=>{
    const isLunch=(r.Aktivitet||"").toLowerCase().includes("lunch");
    const isAll=(r.Deltagare||"").trim().toLowerCase()==="alla";
    if(isLunch&&isAll){
      const specific=rows.some(x=>x.Datum===r.Datum&&x.Start===r.Start&&x.Slut===r.Slut&&
        (x.Aktivitet||"").toLowerCase().includes("lunch")&&
        (x.Deltagare||"").toLowerCase().includes(name.toLowerCase()));
      if(specific) return false;
    }
    return true;
  });
}

// 📋 Dagens schema (kortvy)
function renderCards(name){
  const today=todayKey();
  const rows=applyMioRule(
    DATA.filter(r=>{
      const d=(r.Deltagare||"").toLowerCase();
      return (d.includes(name.toLowerCase())||d==="alla") && dayKey(r.Datum)===today;
    }),name).sort((a,b)=>(a.Start||"").localeCompare(b.Start||""));
  const label=new Intl.DateTimeFormat("sv-SE",{weekday:"long",day:"numeric",month:"long"}).format(new Date(today));
  let html=`<h3>${label}</h3><div class="cards">`;
  if(!rows.length){html+="<p>Inga aktiviteter idag.</p>";}
  rows.forEach(r=>{
    const b=colorFor(r), e=emojiFor(r);
    html+=`<div class="card" style="--band:${b}">
      <h3>${e} ${r.Aktivitet||"Aktivitet"}</h3>
      <div class="row">🕒 ${r.Start||""}–${r.Slut||""}</div>
      <div class="row">🧑‍🏫 Coach: ${r.Coach||"-"}</div>
    </div>`;
  });
  html+="</div>";
  document.getElementById("schemaContainer").innerHTML=html;
  document.getElementById("schemaContainer").style.display="block";
  document.getElementById("blockContainer").style.display="none";
  document.getElementById("viewTitle").textContent=`Dagens schema – ${name}`;
}

// 🧱 blockschema
function makeSlots(){const a=[];for(let h=8;h<=16;h++){a.push(`${String(h).padStart(2,"0")}:00`,`${String(h).padStart(2,"0")}:30`);}a.push("16:30");return a;}
function renderBlocks(name){
  const slots=makeSlots(), days=[...new Set(DATA.map(r=>dayKey(r.Datum)))].sort();
  const rows=applyMioRule(DATA.filter(r=>{
    const d=(r.Deltagare||"").toLowerCase();return d.includes(name.toLowerCase())||d==="alla";
  }),name);
  const head=document.getElementById("blockHeader"), grid=document.getElementById("blockGrid");
  head.innerHTML="<div>Tid</div>"+days.map(d=>`<div>${new Intl.DateTimeFormat("sv-SE",{weekday:"short"}).format(new Date(d))}</div>`).join("");
  grid.innerHTML="";grid.style.gridTemplateColumns=`80px repeat(${days.length},1fr)`;
  slots.forEach(t=>{
    grid.innerHTML+=`<div class="block-time">${t}</div>`+days.map(()=>`<div class="block-cell"></div>`).join("");
  });
  const cells=[...grid.children], dayMap={};days.forEach((d,i)=>dayMap[d]=i+1);
  const toMin=t=>{const [h,m]=t.split(":").map(Number);return h*60+m;};

  rows.forEach(r=>{
    const dk=dayKey(r.Datum),col=dayMap[dk];if(!col)return;
    const sIdx=slots.indexOf(r.Start),eIdx=slots.indexOf(r.Slut);
    if(sIdx<0||eIdx<=sIdx)return;
    const firstCellIndex=(sIdx)*(1+days.length)+col,firstCell=cells[firstCellIndex];
    const block=document.createElement("div");block.className="block";
    block.style.background=colorFor(r);
    const duration=toMin(r.Slut)-toMin(r.Start);
    if(duration<=30){
      block.innerHTML=`${emojiFor(r)} ${r.Aktivitet||""} – ${r.Coach||"-"}`;
    }else{
      block.innerHTML=`${emojiFor(r)} ${r.Aktivitet||""}<br>${r.Start||""}–${r.Slut||""}<br>Coach: ${r.Coach||"-"}`;
    }
    requestAnimationFrame(()=>{const cellH=firstCell.clientHeight||28;block.style.height=(eIdx-sIdx)*cellH+"px";});
    firstCell.appendChild(block);
  });

  const today=new Date();
  const dateLabel=today.toLocaleDateString("sv-SE");
  document.getElementById("viewTitle").textContent=`Veckoschema – ${name} – utskrivet ${dateLabel}`;
  document.getElementById("schemaContainer").style.display="none";
  document.getElementById("blockContainer").style.display="block";
}

// 🔗 direktlänk via URL
function getParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    namn: params.get("namn") || "",
    vy: params.get("vy") || ""
  };
}
function autoOpenFromLink() {
  const { namn, vy } = getParams();
  if (!namn) return;
  const select = document.getElementById("nameSelect");
  const trySelect = () => {
    const option = [...select.options].find(o => o.value.toLowerCase() === namn.toLowerCase());
    if (option) {
      select.value = option.value;
      if (vy === "block") renderBlocks(option.value);
      else renderCards(option.value);
    }
  };
  if (DATA.length) trySelect();
  else setTimeout(trySelect, 800);
}

document.getElementById("btnCards").onclick=()=>{const n=document.getElementById("nameSelect").value;if(n)renderCards(n);};
document.getElementById("btnBlocks").onclick=()=>{const n=document.getElementById("nameSelect").value;if(n)renderBlocks(n);};
document.getElementById("btnPrint").onclick=()=>{window.print();};
// 🔁 Manuell uppdatering från master
document.getElementById("btnReload").onclick=()=>{loadData();};
</script>
</body>
</html>


